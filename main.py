# 1. –í–í–û–î–ù–ê–Ø –ß–ê–°–¢–¨


---



## –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ä–∞–±–æ—Ç—ã:

**–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–æ–≤ (VAE)**

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ

* –ì–µ—Ä–∞—É—Ñ –ù–∏–∫–∏—Ç–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á

## –ö—Ä–∞—Ç–∫–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è

  –î–∞–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ—Å–≤—è—â–µ–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º—ã –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–∞–Ω–æ–º–∞–ª–∏–π –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ (VAE). –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤ –∏–∑ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ Case Western Reserve University (CWRU). –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–¥—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—é—â–∏–π –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –æ—Ü–µ–Ω–∫—É –µ—ë —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∞ —Ç–∞–∫–∂–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –†–∞–±–æ—Ç–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, —Å–ø–æ—Å–æ–±–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤—ã—è–≤–ª—è—Ç—å –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.

# 2. –£–°–¢–ê–ù–û–í–ö–ê –ò –ò–ú–ü–û–†–¢ –ë–ò–ë–õ–ò–û–¢–ï–ö


---
"""

# @title 2.1 –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏, –º–æ–¥–µ–ª—è–º–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π { display-mode: "form" }

import os                                    # –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –ø—É—Ç—è–º–∏
import glob                                  # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –ø–æ —à–∞–±–ª–æ–Ω—É
import numpy as np                           # –ß–∏—Å–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
import matplotlib.pyplot as plt              # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
import torch                                  # PyTorch
import time                                   # –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—É—á–µ–Ω–∏—è
import random                                 # –í—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–∞
import torch.nn as nn                         # –ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–ª–æ–∏
import torch.optim as optim                   # –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä
import torch.nn.functional as F               # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
from torch.utils.data import (
    TensorDataset, DataLoader, WeightedRandomSampler
)
from scipy.signal import butter, filtfilt     # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
from collections import defaultdict           # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª—é—á—É
from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    accuracy_score, roc_auc_score, f1_score,
    roc_curve, confusion_matrix
)

"""# 3. –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨


---

## 3.1. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–†–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π –∏ –∞–Ω–æ–º–∞–ª–∏–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω–æ–π –∑–∞–¥–∞—á–µ–π, –ø–æ–∑–≤–æ–ª—è—é—â–µ–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∞–≤–∞—Ä–∏–∏ –∏ —Å–Ω–∏–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ —Ä–µ–º–æ–Ω—Ç. –í–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å–Ω–∏–º–∞–µ–º—ã–µ —Å –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –≤—Ä–∞—â–∞—é—â–∏—Ö—Å—è –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤, –Ω–µ—Å—É—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. –û–¥–Ω–∞–∫–æ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç—Ä–µ–±—É—é—Ç —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –∏ —Å–ª–æ–∂–Ω—ã –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è, –≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–æ–≤ (VAE), –ø–æ–∑–≤–æ–ª—è—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å, —É–ª—É—á—à–∞—è –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π.

## 3.2. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

**–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–æ–º–∞–ª–∏—è?**
* –ê–Ω–æ–º–∞–ª–∏–µ–π –Ω–∞–∑—ã–≤–∞—é—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
* –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã, –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.

**–í–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**
* –í–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑–º–µ—Ä—è—é—Ç—Å—è –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞–º–∏, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏.
* –°–∏–≥–Ω–∞–ª—ã –º–æ–≥—É—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —É–∑–ª–æ–≤.

**–í–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫ (VAE)**
* –ù–µ–π—Ä–æ—Å–µ—Ç–µ–≤–∞—è –º–æ–¥–µ–ª—å, –æ–±—É—á–∞—é—â–∞—è—Å—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ (—Å–∫—Ä—ã—Ç–æ–µ) –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.
* –õ–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –Ω–∏–∑–∫–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
* –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π.

## 3.3. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

–í–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã–µ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∏ (VAE) ‚Äî —ç—Ç–æ –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—É—á–∞—é—Ç—Å—è –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –∏ –æ—Ü–µ–Ω–∏—Ç—å —Å–∫—Ä—ã—Ç–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤. –û–±—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –ª–æ–≥–∞—Ä–∏—Ñ–º–∞ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ (ELBO):

$$
\log p(x) \geq \mathbb{E}_{q_{\phi}(z|x)}[\log p_{\theta}(x|z)] - \beta \cdot D_{KL}(q_{\phi}(z|x)\|p(z))
$$

- –õ–µ–≤–∞—è —á–∞—Å—Ç—å ‚Äî –ª–æ–≥–∞—Ä–∏—Ñ–º –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è –≤—Ö–æ–¥–∞.
- –ü—Ä–∞–≤–∞—è ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É:
  - **—Ñ—É–Ω–∫—Ü–∏–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** \( \mathbb{E}_{q(z|x)}[\log p(x|z)] \)
  - –∏ **KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–µ–π** –º–µ–∂–¥—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º –∏ –∏—Å—Ç–∏–Ω–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º.

–°—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∞—Ç–µ–Ω—Ç–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö \( z \) –Ω–æ—Ä–º–∞–ª—å–Ω–æ:

$$
q_{\phi}(z|x) = \mathcal{N}\left(z\,|\,\mu(x), \Sigma(x)\right), \quad \Sigma(x) = \text{diag}\left(\sigma_1^2(x), \dots, \sigma_d^2(x)\right)
$$

–ß—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä—É–µ–º–æ—Å—Ç—å, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç—Ä—é–∫ —Ä–µ–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏:

$$
z = \mu(x) + \sigma(x) \odot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)
$$

–í –¥–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö:

$$
\mathcal{L}_{\text{clf}}(y, \hat{y}) = -\sum_{i} y_i \log(\hat{y}_i)
$$

- –ó–¥–µ—Å—å \( y \in \{0,1\} \) ‚Äî –∏—Å—Ç–∏–Ω–Ω–∞—è –º–µ—Ç–∫–∞,
- \( \hat{y} \) ‚Äî –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (—á–µ—Ä–µ–∑ softmax).

–§–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç:

$$
\mathcal{L}_{\text{total}} = \underbrace{\mathcal{L}_{\text{recon}} + \beta \cdot D_{KL}}_{\text{VAE}} + \gamma \cdot \underbrace{\mathcal{L}_{\text{clf}}}_{\text{–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä}}
$$

- –ü–∞—Ä–∞–º–µ—Ç—Ä \( \beta \) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –≤–∫–ª–∞–¥ KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏.
- –ü–∞—Ä–∞–º–µ—Ç—Ä \( \gamma \) —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.

## 3.4. –°—Ö–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```
–í—Ö–æ–¥–Ω–æ–π —Å–∏–≥–Ω–∞–ª
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        –≠–Ω–∫–æ–¥–µ—Ä          ‚îÇ (Conv1D + BatchNorm + LeakyReLU)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –õ–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂ [–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä]
‚îÇ    (Œº, log œÉ¬≤)          ‚îÇ      (Linear + ReLU + Linear)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº (reparam)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       –î–µ–∫–æ–¥–µ—Ä           ‚îÇ (Linear + ConvTranspose1D)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª
```


* –≠–Ω–∫–æ–¥–µ—Ä: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –≤ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.
* –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä: –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–º—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏.
* –î–µ–∫–æ–¥–µ—Ä: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª –∏–∑ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞.

# 4. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•

---

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ CWRU Bearing –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º. –í–∫–ª—é—á–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã: –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–∫–æ–Ω –∏ —Å–æ–∑–¥–∞–Ω–∏—è DataLoader-–æ–≤.

–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–µ–º:
* –ó–∞–≥—Ä—É–∑–∏–º –¥–∞—Ç–∞—Å–µ—Ç –∏–∑ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø—Ä–æ—á–∏—Ç–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã;
* –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –¥–ª–∏–Ω—É –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –ø—Ä–∏–≥–æ–¥–Ω—ã –¥–ª—è –ø–æ–¥–∞—á–∏ –≤ –º–æ–¥–µ–ª—å;
* –ü—Ä–æ–≤–µ–¥—ë–º –±—ã—Å—Ç—Ä—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏;
* –ü—Ä–∏–º–µ–Ω–∏–º –ø–æ–ª–æ—Å–æ–≤—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ Z-–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é;
* –†–∞–∑–¥–µ–ª–∏–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ–±—É—á–∞—é—â—É—é, –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—É—é –∏ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–±–æ—Ä–∫–∏ (60/20/20), —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏–≤—è–∑–∫—É –∫ —Ñ–∞–π–ª–∞–º;
* –ù–∞—Ä–µ–∂–µ–º —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –æ–∫–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤;
* –°–æ–∑–¥–∞–¥–∏–º DataLoader-—ã —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –∫–ª–∞—Å—Å–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º file_id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ—Ü–µ–Ω–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏–≥–Ω–∞–ª–æ–≤.

–≠—Ç–æ—Ç —ç—Ç–∞–ø –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω: –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ VAE –Ω–∞–ø—Ä—è–º—É—é –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤.
"""

# @title 4.1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö { display-mode: "form" }

# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç–∞—Å–µ—Ç CWRU Bearing —Å –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏
!git clone https://github.com/srigas/CWRU_Bearing_NumPy.git

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –¥–∞–Ω–Ω—ã–º–∏
data_dir = 'CWRU_Bearing_NumPy/Data'
files = glob.glob(os.path.join(data_dir, '* RPM', '*.npz'))

# –°–ø–∏—Å–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤, –º–µ—Ç–æ–∫ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤
raw_list, labels, file_ids = [], [], []

# –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤
for fid, path in enumerate(files):
    arr = np.load(path)
    for sig in arr.values():
        raw_list.append(sig.flatten())
        # 0 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, 1 ‚Äî –∞–Ω–æ–º–∞–ª–∏—è
        labels.append(0 if 'Normal' in os.path.basename(path) else 1)
        file_ids.append(fid)

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
print(f"‚ñ∂ –í—Å–µ–≥–æ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(raw_list)}")
print(f"‚ñ∂ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ: {len(set(file_ids))}")

"""–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö CWRU Bearing, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã, —Å–Ω—è—Ç—ã–µ —Å –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö: –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö, —Ç–∞–∫ –∏ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏. –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –≤–∏–¥–µ .npz —Ñ–∞–π–ª–æ–≤ –∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ —á–∏—Å–ª—É –æ–±–æ—Ä–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç–µ–ª—è (RPM).

–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
* –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –¥–∞—Ç–∞—Å–µ—Ç–æ–º: CWRU_Bearing_NumPy.
* –ò–∑ –∫–∞–∂–¥–æ–π –ø–∞–ø–∫–∏ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ —Å—á–∏—Ç–∞–Ω—ã –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã.
* –ö –∫–∞–∂–¥–æ–º—É —Å–∏–≥–Ω–∞–ª—É –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç–∫–∞:
 * 0 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª
 * 1 ‚Äî —Å–∏–≥–Ω–∞–ª —Å –∞–Ω–æ–º–∞–ª–∏–µ–π
* –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω file_id –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –æ–∫–æ–Ω –∫ –∏—Å—Ö–æ–¥–Ω—ã–º —Ñ–∞–π–ª–∞–º.

–ß—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ:
* –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ 411 —Å–∏–≥–Ω–∞–ª–æ–≤.
* –°–∏–≥–Ω–∞–ª—ã –ø–æ—Å—Ç—É–ø–∞—é—Ç –∏–∑ 161 —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

–≠—Ç–æ –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤—É –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–∫–æ–Ω –∏ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.
"""

# @title 4.2. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª–∏–Ω—ã —Å–∏–≥–Ω–∞–ª–æ–≤ { display-mode: "form" }

# –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —Å–∏–≥–Ω–∞–ª–∞ –≤–æ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
min_len = min(map(len, raw_list))

# –û–±—Ä–µ–∑–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö
X_raw = np.stack([s[:min_len] for s in raw_list], axis=0)
y = np.array(labels, dtype=int)
file_ids = np.array(file_ids, dtype=int)

# –†–∞–∑–º–µ—Ä—ã –∏—Ç–æ–≥–æ–≤—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä X_raw: {X_raw.shape}")
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä –º–µ—Ç–æ–∫ y: {y.shape}")
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤: {file_ids.shape}")

"""–í –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—É—é –¥–ª–∏–Ω—É, —á—Ç–æ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å –ø–æ–¥–∞—á–µ–π –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–µ–π—Ä–æ—Å–µ—Ç—å. –ß—Ç–æ–±—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥, –∫–∞–∂–¥—ã–π —Å–∏–≥–Ω–∞–ª –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω –¥–æ –¥–ª–∏–Ω—ã —Å–∞–º–æ–≥–æ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞.

* –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
 * –ù–∞–π–¥–µ–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö 411 —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤.
 * –ö–∞–∂–¥—ã–π —Å–∏–≥–Ω–∞–ª –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω –¥–æ —ç—Ç–æ–π –¥–ª–∏–Ω—ã (63788 –æ—Ç—Å—á—ë—Ç–æ–≤).
 * –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ X_raw —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ (411, 63788).
 * –¢–∞–∫–∂–µ –±—ã–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –º–∞—Å—Å–∏–≤—ã –º–µ—Ç–æ–∫ y –∏ file_ids –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
* –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:
 * –ì–æ—Ç–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É —Å–∏–≥–Ω–∞–ª–æ–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã.
 * –ß—ë—Ç–∫–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏, –∏—Ö –º–µ—Ç–∫–∞–º–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º (—Ñ–∞–π–ª–æ–º).

–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–≤—ë—Ä—Ç–æ—á–Ω—ã–µ —Å–ª–æ–∏ –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏.
"""

# @title 4.3. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–∞—Ç–∞—Å–µ—Ç–∞ { display-mode: "form" }

# –í—ã–±–æ—Ä –ø—Ä–∏–º–µ—Ä–æ–≤: –ø–µ—Ä–≤—ã–µ 2 –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏ –ø–µ—Ä–≤—ã–µ 2 –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–∞
normal_idx = np.where(y == 0)[0][:2]
anomaly_idx = np.where(y == 1)[0][:2]
examples = list(normal_idx) + list(anomaly_idx)
titles = ['–ù–æ—Ä–º–∞'] * 2 + ['–ê–Ω–æ–º–∞–ª–∏—è'] * 2

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
plt.figure(figsize=(12, 6))
for i, (idx, title) in enumerate(zip(examples, titles), 1):
    plt.subplot(2, 2, i)
    plt.plot(X_raw[idx], linewidth=0.8)
    plt.title(f"{title}, —Ñ–∞–π–ª #{file_ids[idx]}")
    plt.xlabel("–û—Ç—Å—á—ë—Ç")
    plt.ylabel("–ê–º–ø–ª–∏—Ç—É–¥–∞")
plt.tight_layout()
plt.show()

"""–î–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ç—ã—Ä–µ –ø—Ä–∏–º–µ—Ä–∞ —Å–∏–≥–Ω–∞–ª–æ–≤:
 * 2 —Å–∏–≥–Ω–∞–ª–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ–¥—à–∏–ø–Ω–∏–∫–∞
 * 2 —Å–∏–≥–Ω–∞–ª–∞, –æ—Ç–Ω–æ—Å—è—â–∏—Ö—Å—è –∫ –∞–Ω–æ–º–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
* –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:
 * –û—Ç–æ–±—Ä–∞–∑–∏–ª–∏ –ø–µ—Ä–≤—ã–µ 2 —Å–∏–≥–Ω–∞–ª–∞ –∏–∑ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ç–∫–∏ y)
 * –ü–æ—Å—Ç—Ä–æ–∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏ –∞–º–ø–ª–∏—Ç—É–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ—Ç—Å—á—ë—Ç–∞–º)
* –ß—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ–º:
 * –°–∏–≥–Ω–∞–ª—ã –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–º–µ—é—Ç —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—É—é –∏ –Ω–∏–∑–∫–æ–∞–º–ø–ª–∏—Ç—É–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
 * –ê–Ω–æ–º–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –≤—ã—Å–æ–∫—É—é –∞–º–ø–ª–∏—Ç—É–¥—É –∏ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ –∫–æ–ª–µ–±–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É—é—â–∏–µ –æ –Ω–∞–ª–∏—á–∏–∏ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π.

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–º–æ–≥–∞–µ—Ç —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –∫–ª–∞—Å—Å–∞–º–∏, –∏ –∑–∞–¥–∞—á–∞ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–º–µ–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª.
"""

# @title 4.4. –ü–æ–ª–æ—Å–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è + Z-score –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ { display-mode: "form" }

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
def bandpass_filter(x, fs=12000, low=1000, high=5000, order=4):
    nyq = fs / 2
    b, a = butter(order, [low / nyq, high / nyq], btype='band')
    return filtfilt(b, a, x)

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ –≤—Å–µ–º —Å–∏–≥–Ω–∞–ª–∞–º
X_filt = np.stack([bandpass_filter(sig) for sig in X_raw], axis=0)

# Z-score –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
means = X_filt.mean(axis=1, keepdims=True)
stds = X_filt.std(axis=1, keepdims=True) + 1e-8
X_norm = (X_filt - means) / stds

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å Conv1D
X_conv = X_norm[:, None, :]

# –ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Conv1D: {X_conv.shape}")

"""* –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:
 * –ü—Ä–∏–º–µ–Ω–∏–ª–∏ –ø–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä –ë–∞—Ç—Ç–µ—Ä–≤–æ—Ä—Ç–∞ (–æ—Ç 1 –¥–æ 5 –∫–ì—Ü) –∫–æ –≤—Å–µ–º —Å–∏–≥–Ω–∞–ª–∞–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —à—É–º–æ–≤ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö —á–∞—Å—Ç–æ—Ç –≤–∏–±—Ä–∞—Ü–∏–∏.
 * –í—ã–ø–æ–ª–Ω–∏–ª–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ Z-–æ—Ü–µ–Ω–∫–µ –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ (–æ–±–Ω—É–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –µ–¥–∏–Ω–∏—á–Ω–æ–π –¥–∏—Å–ø–µ—Ä—Å–∏–∏), —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.
 * –î–æ–±–∞–≤–∏–ª–∏ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞ (1) –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Conv1D, –æ–∂–∏–¥–∞—é—â–∏–º –≤—Ö–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ (batch_size, channels, length).

* –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:
 * –ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: (411, 1, 63788), –≥–¥–µ:
  1. 411 ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤,
  2. 1 ‚Äî –∫–∞–Ω–∞–ª (–¥–ª—è Conv1d),
  3. 63788 ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Å—á—ë—Ç–æ–≤ (–æ–±—Ä–µ–∑–∞–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞).

–≠—Ç–æ—Ç —ç—Ç–∞–ø –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–≤–µ—Ä—Ç–æ—á–Ω–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.
"""

# @title 4.5. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ train/val/test (60/20/20) —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º file_ids { display-mode: "form" }

# –ü–µ—Ä–≤–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ train (60%) –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (40%)
X_tr, X_tmp, raw_tr, raw_tmp, y_tr, y_tmp, fid_tr, fid_tmp = train_test_split(
    X_conv, X_filt, y, file_ids,
    test_size=0.4, stratify=y, random_state=42
)

# –í—Ç–æ—Ä–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω–∞ val (20%) –∏ test (20%)
X_val, X_te, raw_val, raw_te, y_val, y_te, fid_val, fid_te = train_test_split(
    X_tmp, raw_tmp, y_tmp, fid_tmp,
    test_size=0.5, stratify=y_tmp, random_state=42
)

# –†–∞–∑–º–µ—Ä—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–æ–∫
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä Train –≤—ã–±–æ—Ä–∫–∏: {X_tr.shape}, –º–µ—Ç–æ–∫: {y_tr.shape}")
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä Val –≤—ã–±–æ—Ä–∫–∏:   {X_val.shape}, –º–µ—Ç–æ–∫: {y_val.shape}")
print(f"‚ñ∂ –†–∞–∑–º–µ—Ä Test –≤—ã–±–æ—Ä–∫–∏:  {X_te.shape}, –º–µ—Ç–æ–∫: {y_te.shape}")

"""* –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:
 * –ü—Ä–æ–≤–µ–ª–∏ —Å—Ç—Ä–∞—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏—é –Ω–æ—Ä–º/–∞–Ω–æ–º–∞–ª–∏–π –≤ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏:
 1. 60% –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –≤—ã–±–æ—Ä–∫—É (–¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏),
 2. –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 40% —Å–Ω–∞—á–∞–ª–∞ –≤—ã–¥–µ–ª–µ–Ω—ã –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä,
 3. –∑–∞—Ç–µ–º –∏–∑ –Ω–µ–≥–æ –ø–æ–ª—É—á–µ–Ω—ã 20% –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ 20% –¥–ª—è —Ç–µ—Å—Ç–∞.

* –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏:
 * –ü–æ–º–∏–º–æ –≤—Ö–æ–¥–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤, –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ "—Å—ã—Ä—ã–µ" (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ) —Å–∏–≥–Ω–∞–ª—ã, –∞ —Ç–∞–∫–∂–µ file_id ‚Äî –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ file-level –∞–Ω–∞–ª–∏–∑–∞.

* –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:
 * Train: (246, 1, 63788) ‚Äî –º–µ—Ç–æ–∫: 246
 * Val: (82, 1, 63788) ‚Äî –º–µ—Ç–æ–∫: 82
 * Test: (83, 1, 63788) ‚Äî –º–µ—Ç–æ–∫: 83

–¢–∞–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
* –û–±—É—á–∞—Ç—å –º–æ–¥–µ–ª—å –Ω–∞ –æ–±—É—á–∞—é—â–µ–º –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–µ,
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏,
* –û—Ü–µ–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–º —Ç–µ—Å—Ç–µ.
"""

# @title 4.6 –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –æ–∫–Ω–∞ { display-mode: "form" }

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫–Ω–∞ –∏ —à–∞–≥–∞
window, stride = 512, 256

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–∫–æ–Ω –∏–∑ —Å–∏–≥–Ω–∞–ª–æ–≤
def make_windows(X, y, raw, fids):
    Xw, yw, wid = [], [], []
    for xi, yi, ri, fid in zip(X, y, raw, fids):
        for start in range(0, ri.size - window + 1, stride):
            Xw.append(xi[:, start:start + window])
            yw.append(yi)
            wid.append(fid)
    return np.stack(Xw), np.array(yw), np.array(wid)

# –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫ –≤—ã–±–æ—Ä–∫–∞–º
Xw_tr, yw_tr, fidw_tr = make_windows(X_tr, y_tr, raw_tr, fid_tr)
Xw_val, yw_val, fidw_val = make_windows(X_val, y_val, raw_val, fid_val)
Xw_te, yw_te, fidw_te = make_windows(X_te, y_te, raw_te, fid_te)

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –≤ –∫–∞–∂–¥–æ–π –≤—ã–±–æ—Ä–∫–µ
print(f"‚ñ∂ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω:\n  ‚îú‚îÄ‚îÄ Train: {Xw_tr.shape[0]}\n  ‚îú‚îÄ‚îÄ Val:   {Xw_val.shape[0]}\n  ‚îî‚îÄ‚îÄ Test:  {Xw_te.shape[0]}")

"""* –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:
 * –†–∞–∑–±–∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑ –∫–∞–∂–¥–æ–π –≤—ã–±–æ—Ä–∫–∏ –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã:
 1. –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ (window) ‚Äî 512 –æ—Ç—Å—á—ë—Ç–æ–≤,
 2. –®–∞–≥ (stride) ‚Äî 256 –æ—Ç—Å—á—ë—Ç–æ–≤ (50% –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ).
 * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –æ–±—É—á–∞—é—â–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –∏ –ø–æ–≤—ã—Å–∏—Ç—å –æ–±–æ–±—â–∞—é—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏.

* –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:
 * –ê–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫ –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞—Ö —Å–∏–≥–Ω–∞–ª–∞.
 * –û–∫–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π, –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º–µ–Ω–∏.

* –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏:
 * Train: 61‚ÄØ008 –æ–∫–æ–Ω
 * Val: 20‚ÄØ336 –æ–∫–æ–Ω
 * Test: 20‚ÄØ584 –æ–∫–æ–Ω

 –ö–∞–∂–¥–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤—è–∑—å —Å –∏—Å—Ö–æ–¥–Ω–æ–π –º–µ—Ç–∫–æ–π –∏ file_id ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π file-level –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –æ—Ü–µ–Ω–∫–∏.
"""

# @title 4.7 DataLoader‚Äô—ã –¥–ª—è –≤—ã–±–æ—Ä–æ–∫ { display-mode: "form" }

# –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∫–ª–∞—Å—Å–æ–≤ –≤ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ
class_counts = np.bincount(yw_tr)
class_weights = 1.0 / class_counts
sample_weights = class_weights[yw_tr]

# –°–µ–º–ø–ª–µ—Ä —Å —É—á–µ—Ç–æ–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
sampler = WeightedRandomSampler(
    weights=sample_weights,
    num_samples=len(sample_weights),
    replacement=True
)

# DataLoader –¥–ª—è –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏ (—Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π)
train_loader = DataLoader(
    TensorDataset(
        torch.tensor(Xw_tr, dtype=torch.float32),
        torch.tensor(yw_tr, dtype=torch.long)
    ),
    batch_size=64,
    sampler=sampler
)

# DataLoader –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ (—Å file_id, –±–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏)
val_loader = DataLoader(
    TensorDataset(
        torch.tensor(Xw_val, dtype=torch.float32),
        torch.tensor(yw_val, dtype=torch.long),
        torch.tensor(fidw_val, dtype=torch.long)
    ),
    batch_size=64,
    shuffle=False
)

# DataLoader –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏ (—Å file_id, –±–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏)
test_loader = DataLoader(
    TensorDataset(
        torch.tensor(Xw_te, dtype=torch.float32),
        torch.tensor(yw_te, dtype=torch.long),
        torch.tensor(fidw_te, dtype=torch.long)
    ),
    batch_size=64,
    shuffle=False
)

print("‚ñ∂ DataLoader'—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –æ–±—É—á–µ–Ω–∏—é –º–æ–¥–µ–ª–∏.")

"""* –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:
 * –û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω.
 * –î–ª—è –±–æ—Ä—å–±—ã —Å —ç—Ç–∏–º –±—ã–ª –ø—Ä–∏–º–µ–Ω—ë–Ω –≤–∑–≤–µ—à–µ–Ω–Ω—ã–π —Å–µ–º–ø–ª–∏–Ω–≥:
 1. –∫–∞–∂–¥–æ–º—É –ø—Ä–∏–º–µ—Ä—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤–µ—Å, –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —á–∏—Å–ª—É –ø—Ä–∏–º–µ—Ä–æ–≤ –µ–≥–æ –∫–ª–∞—Å—Å–∞,
 2. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WeightedRandomSampler ‚Äî –æ–Ω –ø–æ–¥–∞—ë—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∏ –Ω–∞ –≤—Ö–æ–¥ –º–æ–¥–µ–ª–∏.

* –†–µ–∑—É–ª—å—Ç–∞—Ç:
 * –û–±—É—á–∞—é—â–∏–π DataLoader –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –∫–ª–∞—Å—Å–æ–≤;
 * –í–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–π –∏ —Ç–µ—Å—Ç–æ–≤—ã–π DataLoader:
 1. –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ (shuffle=False),
 2. –≤–∫–ª—é—á–∞—é—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ file_id ‚Äî –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –º–æ–¥–µ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤.

* –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:
 * –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞.
 * file_id ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –ø–æ –≤—Å–µ–º—É —Å–∏–≥–Ω–∞–ª—É.

# 5. –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–ï–õ–ò

---

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ (VAE), –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º. –ú–æ–¥–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–µ—à–∞–µ—Ç –¥–≤–µ –∑–∞–¥–∞—á–∏:
1. –†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞ ‚Äî –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∏–≥–Ω–∞–ª –∞–Ω–æ–º–∞–ª–∏–µ–π, –ø—Ä—è–º–æ –∏–∑ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

* –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç:
 * –≠–Ω–∫–æ–¥–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ Conv1D, —Å–∂–∏–º–∞—é—â–∏–π –≤—Ö–æ–¥–Ω–æ–π —Å–∏–≥–Ω–∞–ª;
 * –õ–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Œº –∏ log(œÉ¬≤);
 * –î–µ–∫–æ–¥–µ—Ä, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π —Å–∏–≥–Ω–∞–ª –∏–∑ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞;
 * –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –æ–±—É—á–∞—é—â–∏–π—Å—è —Ä–∞–∑–ª–∏—á–∞—Ç—å –∫–ª–∞—Å—Å—ã –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º.

* –¢–∞–∫–∂–µ –∑–∞–¥–∞—é—Ç—Å—è:
 * –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (CPU / GPU),
 * –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –∏ –≤–µ—Å–∞ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å,
 * —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å –¥–ª—è VAE –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞.
"""

# @title 5.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã { display-mode: "form" }

class VAEWithClassifier(nn.Module):
    """
    –í–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫ (VAE) —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π.

    –°–æ—Å—Ç–æ–∏—Ç –∏–∑:
    - –≠–Ω–∫–æ–¥–µ—Ä–∞ (—Å–≤—ë—Ä—Ç–æ—á–Ω–∞—è —Å–µ—Ç—å)
    - –õ–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Å–ª–æ—è (Œº –∏ log œÉ¬≤)
    - –î–µ–∫–æ–¥–µ—Ä–∞ (—Ç—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤—ë—Ä—Ç–∫–∏)
    - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
    """
    def __init__(self, latent_dim=64, window_size=window):
        super().__init__()

        # –≠–Ω–∫–æ–¥–µ—Ä: —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏
        self.encoder = nn.Sequential(
            nn.Conv1d(1,   64,  4, 2, 1), nn.BatchNorm1d(64),  nn.LeakyReLU(0.2),
            nn.Conv1d(64, 128,  4, 2, 1), nn.BatchNorm1d(128), nn.LeakyReLU(0.2),
            nn.Conv1d(128,256,  4, 2, 1), nn.BatchNorm1d(256), nn.LeakyReLU(0.2),
            nn.Conv1d(256,512,  4, 2, 1), nn.BatchNorm1d(512), nn.LeakyReLU(0.2)
        )

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞ —ç–Ω–∫–æ–¥–µ—Ä–∞
        with torch.no_grad():
            dummy_input = torch.zeros(1, 1, window_size)
            enc_out = self.encoder(dummy_input)
            self.flat_dim = enc_out.numel()

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        self.fc_mu     = nn.Linear(self.flat_dim, latent_dim)
        self.fc_logvar = nn.Linear(self.flat_dim, latent_dim)

        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π
        self.classifier = nn.Sequential(
            nn.Linear(latent_dim, 64),
            nn.ReLU(),
            nn.Linear(64, 2)
        )

        # –î–µ–∫–æ–¥–µ—Ä: —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
        self.fc_dec = nn.Linear(latent_dim, self.flat_dim)
        self.decoder = nn.Sequential(
            nn.ConvTranspose1d(512,256, 4,2,1), nn.BatchNorm1d(256), nn.LeakyReLU(0.2),
            nn.ConvTranspose1d(256,128, 4,2,1), nn.BatchNorm1d(128), nn.LeakyReLU(0.2),
            nn.ConvTranspose1d(128, 64, 4,2,1), nn.BatchNorm1d(64),  nn.LeakyReLU(0.2),
            nn.ConvTranspose1d(64,   1, 4,2,1), nn.Sigmoid()
        )

    def reparam(self, mu, logvar):
        """–†–µ–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è: z = Œº + œÉ¬∑Œµ"""
        std = (0.5 * logvar).exp()
        eps = torch.randn_like(std)
        return mu + std * eps

    def forward(self, x):
        """–ü—Ä—è–º–æ–π –ø—Ä–æ—Ö–æ–¥: encoder ‚Üí latent ‚Üí decoder & classifier"""
        B = x.size(0)

        # –≠–Ω–∫–æ–¥–µ—Ä
        enc    = self.encoder(x)
        flat   = enc.view(B, -1)
        mu     = self.fc_mu(flat)
        logvar = self.fc_logvar(flat)
        z      = self.reparam(mu, logvar)

        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–∞–Ω–æ–º–∞–ª–∏—è / –Ω–æ—Ä–º–∞)
        logits = self.classifier(z)

        # –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
        dec_flat = self.fc_dec(z).view(B, 512, -1)
        xr       = self.decoder(dec_flat)

        return xr, mu, logvar, logits

"""–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.

–°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å VAEWithClassifier, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –≥–∏–±—Ä–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
* –≠–Ω–∫–æ–¥–µ—Ä —Å 4 —Å–≤—ë—Ä—Ç–æ—á–Ω—ã–º–∏ —Å–ª–æ—è–º–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å–∂–∏–º–∞–µ—Ç –≤—Ö–æ–¥–Ω–æ–π —Å–∏–≥–Ω–∞–ª.
* –õ–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–≤—É–º—è –≤–µ–∫—Ç–æ—Ä–∞–º–∏: Œº –∏ logœÉ¬≤, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å –ø–æ–º–æ—â—å—é —Ç—Ä—é–∫–∞ —Ä–µ–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è z.
* –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –æ–±—É—á–∞—é—â–∏–π—Å—è –Ω–∞ z, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –æ–∫–Ω–∞ –∫ –Ω–æ—Ä–º–µ –∏–ª–∏ –∞–Ω–æ–º–∞–ª–∏–∏.
* –î–µ–∫–æ–¥–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –∏–∑ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –æ—à–∏–±–∫—É —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—É—á–µ–Ω–∏—é –Ω–∞ —Å–∏–≥–Ω–∞–ª–µ, —Ä–∞–∑–±–∏—Ç–æ–º –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –æ–∫–Ω–∞. –°–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –∑–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è.
"""

# @title 5.2. –ì–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å { display-mode: "form" }

# –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (GPU –∏–ª–∏ CPU)
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {device}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
model = VAEWithClassifier(window_size=window).to(device)

# –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä Adam —Å —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–µ–π –≤–µ—Å–æ–≤
optimizer = optim.Adam(model.parameters(), lr=1e-4, weight_decay=1e-5)

# –í–µ—Å–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å (Œ≤-VAE –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)
beta, gamma = 0.1, 1.0

"""–ú–æ–¥–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω.
* –ú–æ–¥–µ–ª—å VAEWithClassifier —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–∑–º–µ—â–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ: GPU (cuda), –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–ª–∏ CPU.
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä Adam —Å –º–∞–ª—ã–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏ (weight_decay=1e-5) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.
* –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤–µ—Å–∞ –¥–ª—è –¥–≤—É—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å:
 * Œ≤ = 0.1 ‚Äî —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∫–ª–∞–¥ KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –≤ –ø–æ—Ç–µ—Ä–∏ VAE.
 * Œ≥ = 1.0 ‚Äî —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –≤–ª–∏—è–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ª–æ—Å—Å–∞.

–°–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–∏–µ —Å–∞–º–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ—Ç–µ—Ä—å –∏ –∑–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.
"""

# @title 5.3. –§—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å –∏ –º–µ—Ç—Ä–∏–∫–∏ { display-mode: "form" }

# –§—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (Mean Squared Error)
recon_loss_fn = nn.MSELoss(reduction='mean')

# –§—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Cross Entropy Loss)
clf_loss_fn = nn.CrossEntropyLoss()

"""–ë—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–≤–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å:
* recon_loss_fn ‚Äî —Å—Ä–µ–¥–Ω–µ–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ (MSE), –∏–∑–º–µ—Ä—è—é—â–∞—è —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞.
* clf_loss_fn ‚Äî –∫—Ä–æ—Å—Å-—ç–Ω—Ç—Ä–æ–ø–∏—è, –ø—Ä–∏–º–µ–Ω—è–µ–º–∞—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞, –æ—Ç–ª–∏—á–∞—é—â–µ–≥–æ –Ω–æ—Ä–º—É –æ—Ç –∞–Ω–æ–º–∞–ª–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.

–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏: –ø–µ—Ä–≤–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å–∏–≥–Ω–∞–ª–∞, –∞ –≤—Ç–æ—Ä–∞—è ‚Äî –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.

# 6. –û–ë–£–ß–ï–ù–ò–ï

---

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—É—á–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å, –≤–∫–ª—é—á–∞—é—â–∞—è:
 * –ü–æ—Ç–µ—Ä—é —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (MSE) –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤;
 * KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—é –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞;
 * –ö—Ä–æ—Å—Å-—ç–Ω—Ç—Ä–æ–ø–∏–π–Ω—É—é –ø–æ—Ç–µ—Ä—é –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–æ—Ä–º/–∞–Ω–æ–º–∞–ª–∏–π.

* –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–∞–Ω–Ω—è—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è: –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —ç–ø–æ—Ö –Ω–µ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

* –í –∫–æ–Ω—Ü–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è –æ–±—â–µ–µ –≤—Ä–µ–º—è, –∑–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ.

–î–∞–ª–µ–µ –±—É–¥—É—Ç –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è: –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Ç–µ—Ä—å, —Ç–æ—á–Ω–æ—Å—Ç–∏, F1 –∏ ROC-AUC –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ü–µ–Ω–∏—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –º–æ–¥–µ–ª—å –æ–±—É—á–∞–µ—Ç—Å—è –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –æ–Ω–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã.
"""

# @title 6.1. –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ { display-mode: "form" }

# –°–ø–∏—Å–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫
train_losses   = []
val_clf_losses = []
val_accuracies = []
val_aucs       = []
val_f1s        = []

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–Ω–Ω–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
best_val_loss = np.inf
patience, wait = 10, 0

start_time = time.time()  # üïí —Å—Ç–∞—Ä—Ç –∑–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è
for epoch in range(1, 101):
    model.train()
    total_vae_loss = 0.0
    total_clf_loss = 0.0

    # –¶–∏–∫–ª —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    for xb, yb in train_loader:
        xb, yb = xb.to(device), yb.to(device)
        optimizer.zero_grad()

        # –ü—Ä—è–º–æ–π –ø—Ä–æ—Ö–æ–¥
        xr, mu, logvar, logits = model(xb)

        # –ü–æ—Ç–µ—Ä–∏ VAE: —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è + Œ≤¬∑KL
        recon = recon_loss_fn(xr, xb)
        kl_div = -0.5 * torch.mean(1 + logvar - mu.pow(2) - logvar.exp())
        loss_vae = recon + beta * kl_div

        # –ü–æ—Ç–µ—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        loss_clf = clf_loss_fn(logits, yb)

        # –û–±—â–∏–µ –ø–æ—Ç–µ—Ä–∏
        loss = loss_vae + gamma * loss_clf
        loss.backward()

        # –û–±—Ä–µ–∑–∫–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ –∏ —à–∞–≥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=1.0)
        optimizer.step()

        total_vae_loss += loss_vae.item() * xb.size(0)
        total_clf_loss += loss_clf.item() * xb.size(0)

    avg_train_loss = (total_vae_loss + gamma * total_clf_loss) / len(train_loader.dataset)
    train_losses.append(avg_train_loss)

    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    model.eval()
    val_logits, val_labels = [], []
    val_loss_clf = 0.0

    with torch.no_grad():
        for xb, yb, _ in val_loader:
            xb, yb = xb.to(device), yb.to(device)
            _, _, _, logits = model(xb)

            l = clf_loss_fn(logits, yb)
            val_loss_clf += l.item() * xb.size(0)

            val_logits.append(logits.cpu())
            val_labels.append(yb.cpu())

    avg_val_clf_loss = val_loss_clf / len(val_loader.dataset)
    val_clf_losses.append(avg_val_clf_loss)

    # –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    all_logits = torch.cat(val_logits)
    all_labels = torch.cat(val_labels).numpy()
    probs_val  = F.softmax(all_logits, dim=1)[:,1].numpy()
    preds_val  = (probs_val > 0.5).astype(int)

    acc = accuracy_score(all_labels, preds_val)
    auc = roc_auc_score(all_labels, probs_val)
    f1  = f1_score(all_labels, preds_val)

    val_accuracies.append(acc)
    val_aucs.append(auc)
    val_f1s.append(f1)

    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–∞–∂–¥–æ–π —ç–ø–æ—Ö–∏
    print(f"–≠–ø–æ—Ö–∞ {epoch:03d}: –ü–æ—Ç–µ—Ä—è –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏={avg_train_loss:.4f}, "
          f"–ü–æ—Ç–µ—Ä—è –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏={avg_val_clf_loss:.4f}, "
          f"–¢–æ—á–Ω–æ—Å—Ç—å={acc:.4f}, –º–µ—Ç—Ä–∏–∫–∞ ROC-AUC={auc:.4f}, –º–µ—Ç—Ä–∏–∫–∞ F1={f1:.4f}")

    # –†–∞–Ω–Ω—è—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    if avg_val_clf_loss < best_val_loss:
        best_val_loss = avg_val_clf_loss
        wait = 0
        torch.save(model.state_dict(), "best_model.pth")  # —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
    else:
        wait += 1
        if wait >= patience:
            print(f"–†–∞–Ω–Ω—è—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —ç–ø–æ—Ö–µ {epoch}")
            model.load_state_dict(torch.load("best_model.pth"))  # –∑–∞–≥—Ä—É–∑–∫–∞ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
            break

# –§–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
end_time = time.time()
elapsed_time = int(end_time - start_time)

# –ü–µ—Ä–µ–≤–æ–¥ –≤ —á—á:–º–º:—Å—Å
hours   = elapsed_time // 3600
minutes = (elapsed_time % 3600) // 60
seconds = elapsed_time % 60

print(f"\n–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞: {hours:02d}—á {minutes:02d}–º {seconds:02d}—Å")

"""–ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞ 33 —ç–ø–æ—Ö–∏, –±–ª–∞–≥–æ–¥–∞—Ä—è –º–µ—Ö–∞–Ω–∏–∑–º—É —Ä–∞–Ω–Ω–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —É–ª—É—á—à–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–æ—Ç–µ—Ä–∏.

–ú–æ–¥–µ–ª—å –ø–æ–∫–∞–∑–∞–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è:
* –ü–æ—Ç–µ—Ä–∏ –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏ –ø–ª–∞–≤–Ω–æ —Å–Ω–∏–∂–∞–ª–∏—Å—å —Å ~0.95 –¥–æ ~0.73
* –ü–æ—Ç–µ—Ä–∏ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–ª–µ–±–∞–ª–∏—Å—å –Ω–∞ –æ—á–µ–Ω—å –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ (–æ—Ç 0.01 –¥–æ <0.001, —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–∑—Ä—ã–≤–∞–º–∏ 0.0485 –∏ 0.0313)
* –ú–µ—Ç—Ä–∏–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ (Accuracy) –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–æ—Å—Ç–∏–≥–∞–ª–∞ 0.9999
* ROC-AUC –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ–∫–æ–ª–æ 1.0000, —É–∫–∞–∑—ã–≤–∞—è –Ω–∞ –≤—ã—Å–æ–∫—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª—è—Ç—å –∫–ª–∞—Å—Å—ã
* 1-–º–µ—Ä–∞ —Ç–∞–∫–∂–µ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –æ–∫–æ–ª–æ 0.9998‚Äì1.0000, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø–æ–ª–Ω–æ—Ç–æ–π –∏ —Ç–æ—á–Ω–æ—Å—Ç—å—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞

–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: 00—á 07–º 49—Å.

–≠—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É—é—Ç –æ —Ç–æ–º, —á—Ç–æ –º–æ–¥–µ–ª—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—É—á–∏–ª–∞—Å—å –∫–∞–∫ –Ω–∞ –∑–∞–¥–∞—á–µ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤, —Ç–∞–∫ –∏ –Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π.
"""

# @title 6.2 –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è { display-mode: "form" }

epochs = range(1, len(train_losses) + 1)
plt.figure(figsize=(12, 8))

# –ü–æ—Ç–µ—Ä–∏ –æ–±—É—á–µ–Ω–∏—è
plt.subplot(2, 2, 1)
plt.plot(epochs, train_losses, label='–ü–æ—Ç–µ—Ä—è –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏')
plt.xlabel('–≠–ø–æ—Ö–∞'); plt.ylabel('–ü–æ—Ç–µ—Ä—è'); plt.title('Train Loss')
plt.legend(); plt.grid(True)

# –ü–æ—Ç–µ—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
plt.subplot(2, 2, 2)
plt.plot(epochs, val_clf_losses, label='–ü–æ—Ç–µ—Ä—è –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', color='orange')
plt.xlabel('–≠–ø–æ—Ö–∞'); plt.ylabel('–ü–æ—Ç–µ—Ä—è'); plt.title('Val Classification Loss')
plt.legend(); plt.grid(True)

# –¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
plt.subplot(2, 2, 3)
plt.plot(epochs, val_accuracies, label='–¢–æ—á–Ω–æ—Å—Ç—å', color='green')
plt.xlabel('–≠–ø–æ—Ö–∞'); plt.ylabel('–¢–æ—á–Ω–æ—Å—Ç—å'); plt.title('Val Accuracy')
plt.legend(); plt.grid(True)

# ROC-AUC –∏ F1 –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
plt.subplot(2, 2, 4)
plt.plot(epochs, val_aucs, label='ROC-AUC', color='red')
plt.plot(epochs, val_f1s, label='F1',       color='purple')
plt.xlabel('–≠–ø–æ—Ö–∞'); plt.ylabel('–ó–Ω–∞—á–µ–Ω–∏–µ'); plt.title('Val ROC-AUC & F1')
plt.legend(); plt.grid(True)

plt.tight_layout(); plt.show()

"""–ù–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ VAE —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º:
* Train Loss: –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –ø–ª–∞–≤–Ω–æ–µ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –æ–±—â–µ–π –ø–æ—Ç–µ—Ä–∏, —á—Ç–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É–µ—Ç –æ–± —É–≤–µ—Ä–µ–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏ –±–µ–∑ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.
* Val Classification Loss: –ø–æ—Ç–µ—Ä–∏ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–ª–µ–±–ª—é—Ç—Å—è –Ω–∞ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ, —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º —É–º–µ–Ω—å—à–µ–Ω–∏–µ–º. –≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ö–æ—Ä–æ—à–µ–π –æ–±–æ–±—â–∞—é—â–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏.
* Val Accuracy: —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å –ø–µ—Ä–≤—ã—Ö —ç–ø–æ—Ö –¥–æ—Å—Ç–∏–≥–∞–µ—Ç >99.8% –∏ –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ–π.
* Val ROC-AUC –∏ F1: –æ–±–µ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.999‚Äì1.000, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è, —á—Ç–æ –º–æ–¥–µ–ª—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∞–Ω–æ–º–∞–ª–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∫–æ—Å–∞ –≤ –æ–¥–Ω—É –∏–∑ —Å—Ç–æ—Ä–æ–Ω.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—É—á–µ–Ω–∏—è –∏ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.

# 7. –û–¶–ï–ù–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

---

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏ –Ω–∞ —Ä–∞–Ω–µ–µ –Ω–µ –≤–∏–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏. –ú—ã –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞, –≤—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞, —Å—Ç—Ä–æ–∏–º ROC-–∫—Ä–∏–≤—É—é –∏ –º–∞—Ç—Ä–∏—Ü—É –æ—à–∏–±–æ–∫, –∞ —Ç–∞–∫–∂–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã.

* –¶–µ–ª–∏ –¥–∞–Ω–Ω–æ–≥–æ —ç—Ç–∞–ø–∞:
 * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤—ã—Ö–æ–¥—ã –º–æ–¥–µ–ª–∏ –≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã.
 * –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–∞, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–∫–æ–Ω.
 * –ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π –ø–æ –º–µ—Ç–æ–¥—É –Æ–¥–µ–Ω–∞.
 * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞: Accuracy, F1, ROC-AUC.
 * –í–∏–∑—É–∞–ª—å–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–∞—Ö.

–≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã –æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.
"""

# @title 7.1 –°–±–æ—Ä –≤—ã—Ö–æ–¥–æ–≤ –º–æ–¥–µ–ª–∏ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤ –∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏ { display-mode: "form" }

model.eval()
logits_list, y_list, fid_list = [], [], []

with torch.no_grad():
    for xb, yb, fids in test_loader:
        xb = xb.to(device)
        _, _, _, logits = model(xb)
        logits_list.append(logits.cpu().numpy())
        y_list.append(yb.numpy())
        fid_list.append(fids.numpy())

# –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è –±–∞—Ç—á–µ–π
logits_arr = np.vstack(logits_list)
y_arr      = np.concatenate(y_list)
fids_arr   = np.concatenate(fid_list)

# –ü–µ—Ä–µ–≤–æ–¥ –ª–æ–≥–∏—Ç–æ–≤ –≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏
probs_arr = F.softmax(torch.from_numpy(logits_arr), dim=1)[:,1].numpy()

"""–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª—å –±—ã–ª–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º –æ—Ü–µ–Ω–∫–∏ (inference), –∏ —Å –µ—ë –ø–æ–º–æ—â—å—é –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã –ª–æ–≥–∏—Ç—ã (—Å—ã—Ä—ã–µ –≤—ã—Ö–æ–¥—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞) –¥–ª—è –≤—Å–µ—Ö –æ–∫–æ–Ω —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏.
* –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ (logits) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º –º–µ—Ç–∫–∏ (y) –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ñ–∞–π–ª–æ–≤ (file_ids) –±—ã–ª–∏ —Å–æ–±—Ä–∞–Ω—ã –≤ –µ–¥–∏–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã.
* –î–∞–ª–µ–µ –ª–æ–≥–∏—Ç—ã –±—ã–ª–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –∫–ª–∞—Å—Å—É "–ê–Ω–æ–º–∞–ª–∏—è" —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ softmax.

–ù–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è —ç—Ç–∏—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤, –ø–æ—Å–∫–æ–ª—å–∫—É –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –æ–∫–æ–Ω.
"""

# @title 7.2 –ê–≥—Ä–µ–≥–∞—Ü–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∞–Ω–æ–º–∞–ª–∏–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É { display-mode: "form" }

file_probs  = defaultdict(list)
file_labels = {}

for p, lbl, fid in zip(probs_arr, y_arr, fids_arr):
    file_probs[int(fid)].append(p)
    file_labels[int(fid)] = int(lbl)

file_ids_unique = sorted(file_probs.keys())
scores_file     = np.array([max(file_probs[f]) for f in file_ids_unique])
labels_file     = np.array([file_labels[f] for f in file_ids_unique])

print("‚ñ∂ ID —Ñ–∞–π–ª–æ–≤:", file_ids_unique)
print("‚ñ∂ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∞–Ω–æ–º–∞–ª–∏–∏:", np.round(scores_file, 4))
print("‚ñ∂ –ò—Å—Ç–∏–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤:", labels_file)

"""–ö–∞–∂–¥–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ–ª–∏ —Å–≤—è–∑–∞–Ω–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ñ–∞–π–ª–æ–º. –ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥ –æ–± –∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞ –≤ —Ü–µ–ª–æ–º, –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –ø–æ –≤—Å–µ–º –æ–∫–Ω–∞–º, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–º –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É.

–ú–µ—Ç–æ–¥ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤—ã–±—Ä–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∞–Ω–æ–º–∞–ª–∏–∏ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –µ–≥–æ –æ–∫–æ–Ω. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –æ–∫–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ, —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–Ω–µ—Å—ë–Ω –∫ –∫–ª–∞—Å—Å—É "–ê–Ω–æ–º–∞–ª–∏—è".

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
* –ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –∞–Ω–æ–º–∞–ª–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ (scores_file)
* –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏—Å—Ç–∏–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ (labels_file)
* –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤ (file-level metrics).
"""

# @title 7.3 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –ø–æ Youden's J { display-mode: "form" }

fpr, tpr, thresholds = roc_curve(labels_file, scores_file)
youden_j             = tpr - fpr
opt_idx              = np.argmax(youden_j)
opt_threshold        = thresholds[opt_idx]

print(f"‚ñ∂ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ (Youden‚Äôs J): {opt_threshold:.4f}")

"""–î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –≤ –±–∏–Ω–∞—Ä–Ω—ã–µ –º–µ—Ç–∫–∏ (–∞–Ω–æ–º–∞–ª–∏—è / –Ω–æ—Ä–º–∞) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –í –¥–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø–æ—Ä–æ–≥ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Å –ø–æ–º–æ—â—å—é –∫—Ä–∏—Ç–µ—Ä–∏—è Youden‚Äôs J, –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (TPR), –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å $(1 - FPR)$:

$$
J=TPR‚àíFPR
$$

* –°—É—Ç—å –º–µ—Ç–æ–¥–∞:
–ú—ã –∏—â–µ–º —Ç–∞–∫–æ–π –ø–æ—Ä–æ–≥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∑–Ω–∞—á–µ–Ω–∏–µ $J$ –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º ‚Äî —Ç–æ –µ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –Ω–∞–∏–ª—É—á—à–∏–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –ª–æ–∂–Ω–æ-–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –ª–æ–∂–Ω–æ-–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º–∏.

* –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞:
–ü–æ –∏—Ç–æ–≥–∞–º –∞–Ω–∞–ª–∏–∑–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –æ–∫–∞–∑–∞–ª—Å—è —Ä–∞–≤–µ–Ω 1.0000, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: —Ñ–∞–π–ª –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ ¬´–∞–Ω–æ–º–∞–ª–∏—è¬ª, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –∞–±—Å–æ–ª—é—Ç–Ω–æ —É–≤–µ—Ä–µ–Ω–∞ –≤ —ç—Ç–æ–º (100% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å).
"""

# @title 7.4 –†–∞—Å—á—ë—Ç file-level –º–µ—Ç—Ä–∏–∫ { display-mode: "form" }

auc_file  = roc_auc_score(labels_file, scores_file)
pred_file = (scores_file >= opt_threshold).astype(int)
acc_file  = accuracy_score(labels_file, pred_file)
f1_file   = f1_score(labels_file, pred_file)

print(f"‚ñ∂ ROC-AUC (—Ñ–∞–π–ª—ã): {auc_file:.4f}")
print(f"‚ñ∂ –¢–æ—á–Ω–æ—Å—Ç—å (—Ñ–∞–π–ª—ã): {acc_file:.4f}")
print(f"‚ñ∂ F1-–º–µ—Ä–∞ (—Ñ–∞–π–ª—ã): {f1_file:.4f}")

"""–ü–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É –º—ã —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞:
* ROC-AUC:
$$ROC - AUC = 1.0000$$
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –∏–¥–µ–∞–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ.

* Accuracy (–¢–æ—á–Ω–æ—Å—Ç—å):
$$Accuracy=1.0000$$
–í—Å–µ 64 —Ñ–∞–π–ª–∞ –±—ã–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫.

* F1-–ú–µ—Ä–∞:
$$F1Score = 1.0000$$
–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø–æ–ª–Ω–æ—Ç–æ–π –∏ —Ç–æ—á–Ω–æ—Å—Ç—å—é —Ç–∞–∫–∂–µ –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º—É–º–∞.

–í—ã–≤–æ–¥:
–ú–æ–¥–µ–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –±–µ–∑–æ—à–∏–±–æ—á–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã—Å–æ–∫—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø–æ–¥—Ö–æ–¥–∞ –æ–±—É—á–µ–Ω–∏—è.
"""

# @title 7.5 –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ROC-–∫—Ä–∏–≤–æ–π –∏ –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ { display-mode: "form" }

# ROC-–∫—Ä–∏–≤–∞—è
plt.figure(figsize=(6,6))
plt.plot(fpr, tpr, label=f"AUC = {auc_file:.3f}")
plt.plot([0,1], [0,1], 'k--', label="–°–ª—É—á–∞–π–Ω—ã–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä")
plt.xlabel("False Positive Rate")
plt.ylabel("True Positive Rate")
plt.title("ROC-–∫—Ä–∏–≤–∞—è (—É—Ä–æ–≤–µ–Ω—å —Ñ–∞–π–ª–æ–≤)")
plt.legend()
plt.grid(True)
plt.show()

# –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫
cm = confusion_matrix(labels_file, pred_file)
fig, ax = plt.subplots(figsize=(5,5))
cax = ax.matshow(cm, cmap='Blues')

for (i, j), v in np.ndenumerate(cm):
    color = 'white' if v > cm.max() / 2 else 'black'
    ax.text(j, i, f"{v}", ha='center', va='center', color=color)

ax.set_xticks([0,1]); ax.set_yticks([0,1])
ax.set_xticklabels(['–ù–æ—Ä–º–∞', '–ê–Ω–æ–º–∞–ª–∏—è'])
ax.set_yticklabels(['–ù–æ—Ä–º–∞', '–ê–Ω–æ–º–∞–ª–∏—è'])
plt.title(f"–ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫ (–ø–æ—Ä–æ–≥={opt_threshold:.4f})")
plt.xlabel("–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ")
plt.ylabel("–ò—Å—Ç–∏–Ω–Ω–æ")
plt.colorbar(cax)
plt.show()

# @title 7.6 –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤ { display-mode: "form" }

# –°–±–æ—Ä –æ–¥–Ω–æ–≥–æ "—Å—ã—Ä–æ–≥–æ" —Å–∏–≥–Ω–∞–ª–∞ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
raw_per_file = {fid: X_raw[idx] for idx, fid in enumerate(file_ids) if fid in file_ids_unique}

# –°–ø–∏—Å–∫–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
norm_files = [f for f in file_ids_unique if file_labels[f] == 0]
anom_files = [f for f in file_ids_unique if file_labels[f] == 1]

# –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ø—Ä–∏–º–µ—Ä–æ–≤
examples = random.sample(norm_files, 2) + random.sample(anom_files, 2)

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
plt.figure(figsize=(12, 6))
for i, fid in enumerate(examples, 1):
    signal = raw_per_file[fid]
    true_lbl = '–ê–Ω–æ–º–∞–ª–∏—è' if file_labels[fid] else '–ù–æ—Ä–º–∞'
    pred_lbl = '–ê–Ω–æ–º–∞–ª–∏—è' if scores_file[file_ids_unique.index(fid)] >= opt_threshold else '–ù–æ—Ä–º–∞'

    plt.subplot(2, 2, i)
    plt.plot(signal, linewidth=0.6)
    plt.title(f"–§–∞–π–ª #{fid} ‚Äî –ò—Å—Ç–∏–Ω–Ω–æ: {true_lbl}, –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ: {pred_lbl}")
    plt.xlabel("–û—Ç—Å—á—ë—Ç —Å–∏–≥–Ω–∞–ª–∞")
    plt.ylabel("–ê–º–ø–ª–∏—Ç—É–¥–∞")

plt.tight_layout()
plt.show()

"""# 8. –í–´–í–û–î–´

---

##	–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–í —Ö–æ–¥–µ –¥–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±—ã–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –æ–±—É—á–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π –Ω–∞ –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–∞—Ö –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–∞ (VAE) —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º. –í –∫–∞—á–µ—Å—Ç–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–∞–±–æ—Ä CWRU Bearing, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –º–µ—Ç–∫–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤.

–ë—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
* –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤,
* –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –¥–ª–∏–Ω–µ,
* –ø–æ–ª–æ—Å–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (Z-score),
* –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –æ–∫–æ–Ω –∏ –∏—Ö —Å—Ç—Ä–∞—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –≤—ã–±–æ—Ä–∫–∏.

–ë—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ VAE —Å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–º –æ–±—É—á–µ–Ω–∏–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –Ω–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –ü–æ—Ç–µ—Ä–∏ –º–æ–¥–µ–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
* —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (MSE),
* —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—é –ª–∞—Ç–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è),
* –∫—Ä–æ—Å—Å-—ç–Ω—Ç—Ä–æ–ø–∏—é –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü–∏–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
* ROC-AUC (–ø–æ —Ñ–∞–π–ª–∞–º): 1.0000
* Accuracy: 1.0000
* F1-–º–µ—Ä–∞: 1.0000

–¢–∞–∫–∂–µ –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:
* –¥–∏–Ω–∞–º–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è,
* —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ROC –∏ confusion matrix,
* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.

–†–∞–Ω–Ω–µ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–º –ø–æ—Ç–µ—Ä—è–º –ø–æ–º–æ–≥–ª–æ –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è, –æ—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏—Å—å –Ω–∞ 33-–π —ç–ø–æ—Ö–µ.

## –ö–∞–∫ –º–æ–¥–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ (–ù–æ—Ä–º–∞ / –ê–Ω–æ–º–∞–ª–∏—è)

–í –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –°–∂–∞—Ç–∏–µ –≤ –ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ:

–≠–Ω–∫–æ–¥–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–≤—ë—Ä—Ç–æ–∫ –∏ –Ω–µ–ª–∏–Ω–µ–π–Ω—ã—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ –≤–µ–∫—Ç–æ—Ä –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ 64. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ "–ø–æ–Ω—è—Ç—å" —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∏–≥–Ω–∞–ª–∞.

2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:

–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –ª–∞—Ç–µ–Ω—Ç–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –ø–æ–¥–∞—ë—Ç—Å—è –≤ –ø–æ–ª–Ω–æ—Å–≤—è–∑–Ω—É—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—É—é –≥–æ–ª–æ–≤–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –∞–Ω–æ–º–∞–ª–∏–∏.
–ù–∞ –≤—ã—Ö–æ–¥–µ ‚Äî –¥–≤–∞ –∑–Ω–∞—á–µ–Ω–∏—è (logits), –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å –ø–æ–º–æ—â—å—é softmax –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∞–Ω–æ–º–∞–ª–∏–∏. –ï—Å–ª–∏ –æ–Ω–∞ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ 1.0000 (–ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é Youden‚Äôs J), —Å–∏–≥–Ω–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–Ω–æ–º–∞–ª—å–Ω—ã–º.

## –ö–∞–∫–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç –∞–Ω–æ–º–∞–ª–∏–µ–π

–ú–æ–¥–µ–ª—å —Å–∫–ª–æ–Ω–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç—å —Å–∏–≥–Ω–∞–ª –∫ "–ê–Ω–æ–º–∞–ª–∏–∏", –µ—Å–ª–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –æ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è:

* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∞–º–ø–ª–∏—Ç—É–¥—ã —Å–∏–≥–Ω–∞–ª–∞:

–ü—Ä–∏–º–µ—Ä—ã –∞–Ω–æ–º–∞–ª–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –ø–∏–∫–∏ –¥–æ 4‚Äì6 –µ–¥–∏–Ω–∏—Ü –∞–º–ø–ª–∏—Ç—É–¥—ã, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ¬±0.2 ‚Äì ¬±0.3.

* –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏:

–°–∏–≥–Ω–∞–ª—ã —Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤) –Ω–∞—á–∏–Ω–∞—é—Ç "—Ä–∞–∑—Ä—É—à–∞—Ç—å—Å—è", –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ö–∞–æ—Ç–∏—á–Ω—ã–µ —Ñ–æ—Ä–º—ã.

* –ò—Å–∫–∞–∂–µ–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞:

–ü–æ—Å–ª–µ –ø–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (1000‚Äì5000 –ì—Ü) –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª—å –≤—Å—ë –µ—â—ë —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–æ—â–Ω–æ—Å—Ç–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.

## –†–æ–ª—å KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏

KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è (–≤ —Å—Ä–µ–¥–Ω–µ–º —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –æ—Ç 0.001 –¥–æ 0.01 —É –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã—à–µ —É –∞–Ω–æ–º–∞–ª–∏–π) —Å–ª—É–∂–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º —Ç–æ–≥–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç "–æ–∂–∏–¥–∞–µ–º–æ–≥–æ" –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ.

–ï—Å–ª–∏ –ª–∞—Ç–µ–Ω—Ç–Ω—ã–π –≤–µ–∫—Ç–æ—Ä $ùëß$ —Å–∏–ª—å–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –æ—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–≥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è $ùëÅ(0,ùêº)$, —Ç–æ —ç—Ç–æ —Ç–∞–∫–∂–µ –ø–æ–≤—ã—à–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—à–∏–±–∫—É, —É—Å–∏–ª–∏–≤–∞—è —Å–∏–≥–Ω–∞–ª –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –∞–Ω–æ–º–∞–ª–∏–∏.

##	–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞

–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∑–∞–Ω—è–ª–æ:

* 07 –º–∏–Ω—É—Ç 49 —Å–µ–∫—É–Ω–¥

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –Ω–∞ GPU (cuda), —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±—ã—Å—Ç—Ä—É—é —Å—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–∫–æ–Ω.

##	–ü—Ä–æ–±–ª–µ–º—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. –î–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—ã–ª —Ä–µ—à—ë–Ω —Å –ø–æ–º–æ—â—å—é –≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ —Å–µ–º–ø–ª–µ—Ä–∞. –û–¥–Ω–∞–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è—Ö –≤–æ–∑–º–æ–∂–Ω—ã –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ –∏–ª–∏ —Ä–µ–¥–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–∂–Ω–µ–µ –≤—ã—è–≤–∏—Ç—å.
2. –ú–æ–¥–µ–ª—å –æ–±—É—á–∞–ª–∞—Å—å –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ VAE + –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–≤–µ—Ä—Ç–æ—á–Ω—ã—Ö attention-–º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –∏–ª–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–≤—ã—Å–∏—Ç—å –æ–±–æ–±—â–∞—é—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.
3.–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–∞.

## –ò—Ç–æ–≥

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–¥–∞—á–µ –±–∏–Ω–∞—Ä–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø–æ–¥—à–∏–ø–Ω–∏–∫–æ–≤, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—è –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π —Ü–µ–ª–∏ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—é –∞–Ω–æ–º–∞–ª–∏–π –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ —Å–≤—è–∑–∫–µ —Å –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã–º –∞–≤—Ç–æ–∫–æ–¥–∏—Ä–æ–≤—â–∏–∫–æ–º –Ω–µ –ø—Ä–æ—Å—Ç–æ "—É–≥–∞–¥—ã–≤–∞–µ—Ç" –º–µ—Ç–∫—É, –∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É, —Å–∏–ª—É –∏ —Ä–∏—Ç–º —Å–∏–≥–Ω–∞–ª–∞, –ø—Ä–∏–Ω–∏–º–∞—è —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–ª—É–±–æ–∫–æ –≤—ã—É—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –≤ —Ç–æ–º —á–∏—Å–ª–µ ‚Äî KL-–¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∏ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
"""